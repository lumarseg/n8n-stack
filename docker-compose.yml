# =============================================================================
# n8n Stack - Automation Platform (Task Runners Mode)
# =============================================================================
#
# CONTENIDO:
# - [001] Volúmenes: n8n_storage
# - [002] Redes: backend_net, proxy_net (external)
# - [020] n8n Main: UI, webhooks, task broker
# - [040] Task Runners: 2 JavaScript + 2 Python runners especializados
# - [100] Healthchecks: Main, Task Runners
# - [200] Traefik: Labels, routing, SSL (Main)
# - [300] Security: Rate limiting, headers (Main)
#
# ARQUITECTURA:
# - Task Runners Mode: Main maneja broker, runners ejecutan código en sandbox
# - Runners especializados: 2 para JavaScript, 2 para Python
# - Task runners en contenedores sidecar separados
# - Autenticación con N8N_RUNNERS_AUTH_TOKEN
# - Shared storage: Main y runners comparten n8n_storage
#
# DEPLOYMENT:
# docker compose up -d
#
# PREREQUISITOS:
# docker network create backend_net
# docker network create proxy_net
# docker compose -f postgres.yaml up -d  # PostgreSQL debe estar corriendo
#
# NOTAS:
# - Main y runners usan restart: unless-stopped (auto-recovery)
# - depends_on postgres no funciona (archivo diferente)
# - Si postgres no está listo, contenedores se reinician hasta conectar
# - Task runners requieren n8n v2.0+ con imagen n8nio/runners
#
# =============================================================================

# [001] Volúmenes
volumes:
  n8n_storage:

# [002] Redes
networks:
  backend_net:
    external: true
  proxy_net:
    external: true

services:
  # ===========================================================================
  # [020] n8n Main - Interfaz web, webhooks, task broker
  # ===========================================================================
  main:
    image: n8nio/n8n:2.0.1
    restart: unless-stopped
    container_name: n8n-main
    extra_hosts:
      - "host.docker.internal:host-gateway"

    environment:
      # [020.1] General
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      - NODE_ENV=production
      - N8N_PORT=5678
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_SECURE_COOKIE=false
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_VERSION_NOTIFICATIONS_ENABLED=false
      - N8N_TEMPLATES_ENABLED=true

      # [020.2] URLs
      - N8N_EDITOR_BASE_URL=https://app.n8n.luismaroto.com
      - WEBHOOK_URL=https://app.n8n.luismaroto.com/
      - N8N_PROXY_HOPS=1

      # [020.3] PostgreSQL (servicio en postgres.yaml)
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=${POSTGRES_HOST}
      - DB_POSTGRESDB_PORT=${POSTGRES_PORT}
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}

      # [020.4] Task Runners Mode
      - N8N_RUNNERS_ENABLED=true
      - N8N_RUNNERS_MODE=external
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
      - N8N_RUNNERS_BROKER_LISTEN_ADDRESS=0.0.0.0

      # [020.5] Security
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=true
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true

    volumes:
      - n8n_storage:/home/node/.n8n

    networks:
      - backend_net
      - proxy_net

    # [100.2] Healthcheck Main
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5678/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

    # [200] Traefik Labels
    labels:
      - "traefik.enable=true"

      # [300.1] Rate Limiting: 100 req/min, 50 burst
      - "traefik.http.middlewares.n8n-ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.n8n-ratelimit.ratelimit.period=1m"
      - "traefik.http.middlewares.n8n-ratelimit.ratelimit.burst=50"

      # [300.2] Security Headers
      - "traefik.http.middlewares.n8n-security.headers.framedeny=true"
      - "traefik.http.middlewares.n8n-security.headers.browserxssfilter=true"
      - "traefik.http.middlewares.n8n-security.headers.contenttypenosniff=true"
      - "traefik.http.middlewares.n8n-security.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.n8n-security.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.n8n-security.headers.stsPreload=true"
      - "traefik.http.middlewares.n8n-security.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.n8n-security.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.n8n-security.headers.permissionsPolicy=geolocation=(), microphone=(), camera=()"

      # [200.1] Router HTTPS
      - "traefik.http.routers.n8n-secure.rule=Host(`app.n8n.luismaroto.com`)"
      - "traefik.http.routers.n8n-secure.entrypoints=websecure"
      - "traefik.http.routers.n8n-secure.tls=true"
      - "traefik.http.routers.n8n-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.n8n-secure.service=n8n"
      - "traefik.http.routers.n8n-secure.middlewares=n8n-ratelimit,n8n-security"

      # [200.2] Router HTTP redirect
      - "traefik.http.routers.n8n.rule=Host(`app.n8n.luismaroto.com`)"
      - "traefik.http.routers.n8n.entrypoints=web"
      - "traefik.http.routers.n8n.middlewares=redirect-to-https"

      # [200.3] Service
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"

      # [200.4] Traefik Healthcheck
      - "traefik.http.services.n8n.loadbalancer.healthcheck.path=/healthz"
      - "traefik.http.services.n8n.loadbalancer.healthcheck.interval=10s"
      - "traefik.http.services.n8n.loadbalancer.healthcheck.timeout=5s"
      - "traefik.http.services.n8n.loadbalancer.healthcheck.scheme=http"

  # ===========================================================================
  # [040] Task Runners - Runners especializados para ejecución de código
  # ===========================================================================
  # - 2 runners especializados en JavaScript
  # - 2 runners especializados en Python
  # - Cada runner: max 5 tareas concurrentes, auto-shutdown 15s
  # ===========================================================================

  # JavaScript Runners (2x)
  runner-js-1:
    image: n8nio/runners:2.0.1
    restart: unless-stopped
    container_name: n8n-runner-js-1
    extra_hosts:
      - "host.docker.internal:host-gateway"

    entrypoint: ["/bin/sh", "-c", "/usr/local/bin/task-runner-launcher javascript;"]

    environment:
      # [040.1] JavaScript Runner 1 Config
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
      - N8N_RUNNERS_TASK_BROKER_URI=http://main:5679
      - N8N_RUNNERS_MAX_CONCURRENCY=${RUNNERS_JS_MAX_CONCURRENCY}
      - N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT=${RUNNERS_JS_AUTO_SHUTDOWN}

    volumes:
      - n8n_storage:/home/node/.n8n

    networks:
      - backend_net

    # [100.3] Healthcheck JavaScript Runner 1
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5680/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

    depends_on:
      main:
        condition: service_healthy

  runner-js-2:
    image: n8nio/runners:2.0.1
    restart: unless-stopped
    container_name: n8n-runner-js-2
    extra_hosts:
      - "host.docker.internal:host-gateway"

    entrypoint: ["/bin/sh", "-c", "/usr/local/bin/task-runner-launcher javascript;"]

    environment:
      # [040.2] JavaScript Runner 2 Config
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
      - N8N_RUNNERS_TASK_BROKER_URI=http://main:5679
      - N8N_RUNNERS_MAX_CONCURRENCY=${RUNNERS_JS_MAX_CONCURRENCY}
      - N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT=${RUNNERS_JS_AUTO_SHUTDOWN}

    volumes:
      - n8n_storage:/home/node/.n8n

    networks:
      - backend_net

    # [100.4] Healthcheck JavaScript Runner 2
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5680/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

    depends_on:
      main:
        condition: service_healthy

  # Python Runners (2x)
  runner-py-1:
    image: n8nio/runners:2.0.1
    restart: unless-stopped
    container_name: n8n-runner-py-1
    extra_hosts:
      - "host.docker.internal:host-gateway"

    entrypoint: ["/bin/sh", "-c", "/usr/local/bin/task-runner-launcher python;"]

    environment:
      # [040.3] Python Runner 1 Config
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
      - N8N_RUNNERS_TASK_BROKER_URI=http://main:5679
      - N8N_RUNNERS_MAX_CONCURRENCY=${RUNNERS_PY_MAX_CONCURRENCY}
      - N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT=${RUNNERS_PY_AUTO_SHUTDOWN}

    volumes:
      - n8n_storage:/home/node/.n8n

    networks:
      - backend_net

    # [100.5] Healthcheck Python Runner 1
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5680/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

    depends_on:
      main:
        condition: service_healthy

  runner-py-2:
    image: n8nio/runners:2.0.1
    restart: unless-stopped
    container_name: n8n-runner-py-2
    extra_hosts:
      - "host.docker.internal:host-gateway"

    entrypoint: ["/bin/sh", "-c", "/usr/local/bin/task-runner-launcher python;"]

    environment:
      # [040.4] Python Runner 2 Config
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
      - N8N_RUNNERS_TASK_BROKER_URI=http://main:5679
      - N8N_RUNNERS_MAX_CONCURRENCY=${RUNNERS_PY_MAX_CONCURRENCY}
      - N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT=${RUNNERS_PY_AUTO_SHUTDOWN}

    volumes:
      - n8n_storage:/home/node/.n8n

    networks:
      - backend_net

    # [100.6] Healthcheck Python Runner 2
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5680/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

    depends_on:
      main:
        condition: service_healthy
